<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®çŸ³å¯¹å¯¹ç¢°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }
        
        h1 {
            font-size: 3.2rem;
            background: linear-gradient(90deg, #ff9a00, #ff0058, #00d4ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            animation: titleGlow 3s infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 10px rgba(255, 154, 0, 0.5); }
            100% { text-shadow: 0 0 20px rgba(0, 212, 255, 0.7); }
        }
        
        .game-description {
            font-size: 1.1rem;
            color: #b0b0d0;
            max-width: 900px;
            margin: 0 auto 20px;
            line-height: 1.6;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 300px;
        }
        
        .right-panel {
            flex: 2;
            min-width: 300px;
        }
        
        .panel {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel-title {
            font-size: 1.5rem;
            color: #6ee7b7;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(110, 231, 183, 0.3);
        }
        
        .panel-title i {
            font-size: 1.8rem;
        }
        
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .color-option {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.7);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .color-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .color-option:hover::before {
            opacity: 1;
            animation: shine 1.5s infinite;
        }
        
        .color-option:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .color-option.selected {
            transform: scale(1.2) rotate(0deg);
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px #6ee7b7, 0 0 20px rgba(110, 231, 183, 0.7);
            animation: pulseSelected 2s infinite;
        }
        
        @keyframes pulseSelected {
            0% { box-shadow: 0 0 0 3px #fff, 0 0 0 6px #6ee7b7, 0 0 20px rgba(110, 231, 183, 0.7); }
            50% { box-shadow: 0 0 0 3px #fff, 0 0 0 10px rgba(110, 231, 183, 0.5), 0 0 30px rgba(110, 231, 183, 0.9); }
            100% { box-shadow: 0 0 0 3px #fff, 0 0 0 6px #6ee7b7, 0 0 20px rgba(110, 231, 183, 0.7); }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 160px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s;
            z-index: -1;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        #playOnceBtn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
        }
        
        #playOnceBtn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 176, 155, 0.5);
        }
        
        #resetBtn {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        #resetBtn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 65, 108, 0.5);
        }
        
        #playTenBtn {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
            color: white;
        }
        
        #playTenBtn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(142, 45, 226, 0.5);
        }
        
        .game-grid-container {
            position: relative;
            margin-bottom: 40px;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }
        
        .grid-bg {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 25px;
            z-index: 1;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }
        
        .gem {
            aspect-ratio: 1;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.2), 
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            transition: all 0.5s;
            position: relative;
            overflow: hidden;
            z-index: 2;
        }
        
        .gem::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
            z-index: -1;
            border-radius: 15px;
        }
        
        .gem::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: -1;
        }
        
        .gem.matched::after {
            opacity: 1;
            animation: gemShine 1s ease-out;
        }
        
        @keyframes gemShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .gem.lucky {
            animation: luckyPulse 1.5s infinite, gemFloat 3s infinite ease-in-out;
        }
        
        @keyframes luckyPulse {
            0% { box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2), 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 0 0 rgba(110, 231, 183, 0.7); }
            70% { box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2), 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 0 20px rgba(110, 231, 183, 0); }
            100% { box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2), 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 0 0 rgba(110, 231, 183, 0); }
        }
        
        @keyframes gemFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .gem.removing {
            animation: gemRemove 0.8s forwards;
        }
        
        @keyframes gemRemove {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .gem.appearing {
            animation: gemAppear 0.8s forwards;
        }
        
        @keyframes gemAppear {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px 20px;
            flex: 1;
            min-width: 170px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stat-box:hover::before {
            opacity: 1;
        }
        
        .stat-value {
            font-size: 3.2rem;
            font-weight: bold;
            color: #6ee7b7;
            line-height: 1;
            text-shadow: 0 0 10px rgba(110, 231, 183, 0.5);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: #b0b0d0;
            margin-top: 8px;
        }
        
        .game-session-stats {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .session-title {
            font-size: 1.2rem;
            color: #6ee7b7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-results {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .session-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .session-result.highlight {
            background: rgba(110, 231, 183, 0.2);
            border: 1px solid #6ee7b7;
        }
        
        .session-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.1rem;
            color: #fbbf24;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-title {
            font-size: 1.2rem;
            color: #6ee7b7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-entry {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #6ee7b7;
            animation: fadeIn 0.5s;
            position: relative;
            overflow: hidden;
        }
        
        .log-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            transform: translateX(-100%);
        }
        
        .log-entry.new::before {
            animation: logHighlight 1s forwards;
        }
        
        @keyframes logHighlight {
            to { transform: translateX(100%); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .log-entry.match {
            border-left-color: #fbbf24;
        }
        
        .log-entry.bonus {
            border-left-color: #8b5cf6;
        }
        
        .log-entry.final {
            border-left-color: #10b981;
            font-weight: bold;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .rules {
            margin-top: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .rules h2 {
            color: #6ee7b7;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rules ul {
            padding-left: 20px;
            color: #b0b0d0;
            line-height: 1.6;
        }
        
        .rules li {
            margin-bottom: 10px;
            padding-left: 5px;
        }
        
        /* åé¦ˆæ–‡æœ¬æ ·å¼ */
        .feedback-text {
            position: absolute;
            font-weight: bold;
            font-size: 1.4rem;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
            animation: floatUp 1.5s forwards;
            white-space: nowrap;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(0.8); opacity: 0; }
        }
        
        .feedback-lucky {
            color: #6ee7b7;
        }
        
        .feedback-bonus {
            color: #fbbf24;
        }
        
        .feedback-fullhouse {
            color: #8b5cf6;
        }
        
        .feedback-pair {
            color: #f87171;
        }
        
        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .step {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-weight: bold;
            color: #b0b0d0;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .step.active {
            background: rgba(110, 231, 183, 0.2);
            color: #6ee7b7;
            box-shadow: 0 0 15px rgba(110, 231, 183, 0.3);
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(110, 231, 183, 0.3), transparent);
            transition: left 0.7s;
        }
        
        .step.active::after {
            left: 100%;
        }
        
        /* åŠ¨ç”»å®çŸ³ */
        .animated-gem {
            position: absolute;
            font-size: 2rem;
            z-index: 50;
            pointer-events: none;
            animation: flyGem 1s forwards;
        }
        
        @keyframes flyGem {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: var(--target-pos) scale(0.5); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .controls {
                justify-content: center;
            }
            
            button {
                min-width: 100%;
            }
            
            .stats {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.5rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-gem"></i> å®çŸ³å¯¹å¯¹ç¢°</h1>
            <p class="game-description">é€‰æ‹©å¹¸è¿è‰²å®çŸ³ï¼Œè¿›è¡Œå•æ¬¡æˆ–å¤šæ¬¡æ¸¸æˆï¼Œæ¯æ¬¡æ¸¸æˆç¢°æ•°ç‹¬ç«‹è®¡ç®—ï¼</p>
        </header>
        
        <div class="game-area">
            <div class="left-panel">
                <div class="panel">
                    <div class="panel-title">
                        <i class="fas fa-palette"></i> é€‰æ‹©å¹¸è¿è‰²
                    </div>
                    
                    <div class="color-picker" id="colorPicker">
                        <!-- é¢œè‰²é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="panel-title">
                        <i class="fas fa-gamepad"></i> æ¸¸æˆæ§åˆ¶
                    </div>
                    
                    <div class="controls">
                        <button id="playOnceBtn">
                            <i class="fas fa-play"></i> ç¢°1æ¬¡
                        </button>
                        <button id="playTenBtn">
                            <i class="fas fa-bolt"></i> ç¢°10æ¬¡
                        </button>
                        <button id="resetBtn">
                            <i class="fas fa-redo"></i> é‡ç½®æ¸¸æˆ
                        </button>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="touchCount">0</div>
                            <div class="stat-label">å½“å‰ç¢°æ•°</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="reserveGems">0</div>
                            <div class="stat-label">å¤‡ç”¨å®çŸ³</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="roundCount">0</div>
                            <div class="stat-label">æ¸¸æˆè½®æ¬¡</div>
                        </div>
                    </div>
                    
                    <div class="game-session-stats">
                        <div class="session-title">
                            <i class="fas fa-chart-bar"></i> æ¸¸æˆä¼šè¯ç»Ÿè®¡
                        </div>
                        <div id="sessionResults" class="session-results">
                            <div class="session-result">æš‚æ— æ¸¸æˆè®°å½•</div>
                        </div>
                        <div id="sessionTotal" class="session-total"></div>
                    </div>
                </div>
                
                <div class="log-container">
                    <div class="log-title">
                        <i class="fas fa-scroll"></i> æ¸¸æˆæ¼”ç®—æ—¥å¿—
                    </div>
                    <div id="gameLog">
                        <div class="log-entry">
                            ç­‰å¾…æ¸¸æˆå¼€å§‹...è¯·é€‰æ‹©å¹¸è¿è‰²å¹¶ç‚¹å‡»"ç¢°1æ¬¡"æˆ–"ç¢°10æ¬¡"
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-title">
                        <i class="fas fa-border-all"></i> å®çŸ³ä¹å®«æ ¼æ¼”ç®—åŒº
                    </div>
                    
                    <div class="step-indicator">
                        <div class="step" id="step1">å¹¸è¿è‰²åˆ¤æ–­</div>
                        <div class="step" id="step2">å…¨å®¶ç¦åˆ¤æ–­</div>
                        <div class="step" id="step3">ä¸‰è¿åˆ¤æ–­</div>
                        <div class="step" id="step4">å¯¹å­åˆ¤æ–­</div>
                        <div class="step" id="step5">å®çŸ³è¡¥å……</div>
                    </div>
                    
                    <div class="game-grid-container">
                        <div class="grid-bg"></div>
                        <div class="game-grid" id="gameGrid">
                            <!-- å®çŸ³æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="panel-title">
                        <i class="fas fa-info-circle"></i> å½“å‰æ¼”ç®—çŠ¶æ€
                    </div>
                    
                    <div id="gameStatus">
                        <p>æ¸¸æˆå‡†å¤‡ä¸­...è¯·é€‰æ‹©å¹¸è¿è‰²</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="rules">
            <h2><i class="fas fa-book"></i> æ¸¸æˆæ¼”ç®—è§„åˆ™ï¼ˆæ”¹è¿›ç‰ˆï¼‰</h2>
            <ul>
                <li><strong>ç¬¬1æ­¥ - å¹¸è¿è‰²åˆ¤æ–­ï¼š</strong>ä¹å®«æ ¼ä¸­æ¯å­˜åœ¨1ä¸ªä¸å¹¸è¿è‰²ç›¸åŒçš„å®çŸ³ï¼Œç¢°æ•°+1ï¼Œå¤‡ç”¨å®çŸ³+1ï¼ˆæ¯æšå®çŸ³åªå‚ä¸1æ¬¡å¹¸è¿è‰²åˆ¤æ–­ï¼‰</li>
                <li><strong>ç¬¬2æ­¥ - å…¨å®¶ç¦åˆ¤æ–­ï¼š</strong>è‹¥ä¹å®«æ ¼ä¸­å­˜åœ¨9ä¸ªé¢œè‰²å„ä¸ç›¸åŒçš„å®çŸ³ï¼Œç¢°æ•°+10ï¼Œå¤‡ç”¨å®çŸ³+10ï¼Œæ¶ˆé™¤å…¨å®¶ç¦å®çŸ³</li>
                <li><strong>ç¬¬3æ­¥ - ä¸‰è¿åˆ¤æ–­ï¼š</strong>æ¯å­˜åœ¨è¿ç»­3ä¸ªé¢œè‰²ç›¸åŒçš„å®çŸ³ï¼ˆæ¨ªã€ç«–ã€æ–œï¼‰ï¼Œç¢°æ•°+5ï¼Œå¤‡ç”¨å®çŸ³+5ï¼Œæ¶ˆé™¤ä¸‰è¿å®çŸ³</li>
                <li><strong>ç¬¬4æ­¥ - å¯¹å­åˆ¤æ–­ï¼š</strong>å‰©ä½™å®çŸ³ä¸­æ¯å­˜åœ¨2ä¸ªé¢œè‰²ç›¸åŒçš„å®çŸ³ï¼ˆæ— è®ºæ˜¯å¦ç›¸é‚»ï¼‰ï¼Œç¢°æ•°+1ï¼Œå¤‡ç”¨å®çŸ³+1ï¼Œæ¶ˆé™¤å¯¹å­å®çŸ³</li>
                <li><strong>ç¬¬5æ­¥ - è¡¥å……å®çŸ³ï¼š</strong>æ¶ˆè€—å¤‡ç”¨å®çŸ³è¡¥å……éšæœºå®çŸ³ï¼ˆä»å·¦è‡³å³ã€ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼‰</li>
                <li><strong>é‡å¤ç¬¬1~5æ­¥ï¼Œ</strong>ç›´è‡³å¤‡ç”¨å®çŸ³ä¸º0ï¼Œæ ¹æ®ç´¯è®¡ç¢°æ•°å‘æ”¾å¥–åŠ±</li>
                <li><strong>æ–°å¢åŠŸèƒ½ï¼š</strong>"ç¢°1æ¬¡"æŒ‰é’®è¿›è¡Œå•æ¬¡æ¸¸æˆï¼Œ"ç¢°10æ¬¡"æŒ‰é’®è¿ç»­è¿›è¡Œ10æ¬¡ç‹¬ç«‹æ¸¸æˆï¼Œæ¯æ¬¡æ¸¸æˆç¢°æ•°ç‹¬ç«‹è®¡ç®—</li>
            </ul>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const COLORS = [
            {name: "çº¢", value: "#ff4757", emoji: "ğŸ”´"},
            {name: "æ©™", value: "#ffa502", emoji: "ğŸŸ "},
            {name: "é»„", value: "#ffd32a", emoji: "ğŸŸ¡"},
            {name: "ç»¿", value: "#2ed573", emoji: "ğŸŸ¢"},
            {name: "é’", value: "#1e90ff", emoji: "ğŸ”µ"},
            {name: "è“", value: "#3742fa", emoji: "ğŸ”·"},
            {name: "é›", value: "#7158e2", emoji: "ğŸ’ "},
            {name: "ç´«", value: "#9c88ff", emoji: "ğŸŸ£"},
            {name: "ç²‰", value: "#ff9ff3", emoji: "ğŸŒ¸"},
            {name: "é»‘", value: "#2f3542", emoji: "âš«"}
        ];
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            luckyColor: null,
            gems: [], // 3x3å®çŸ³æ•°ç»„
            touchCount: 0,
            reserveGems: 0,
            roundCount: 0,
            gameActive: false,
            currentStep: 0, // å½“å‰æ­¥éª¤
            luckyChecked: [] // è®°å½•å·²æ£€æŸ¥è¿‡å¹¸è¿è‰²çš„å®çŸ³ä½ç½®
        };
        
        // æ¸¸æˆä¼šè¯ç»Ÿè®¡
        let gameSessions = {
            results: [], // å­˜å‚¨æ¯æ¬¡æ¸¸æˆçš„ç¢°æ•°
            totalTouches: 0, // æ€»ç¢°æ•°
            currentSession: 0 // å½“å‰ä¼šè¯ç¼–å·
        };
        
        // DOMå…ƒç´ 
        let colorPicker, gameGrid, touchCountEl, reserveGemsEl, roundCountEl, gameLog, gameStatus;
        let sessionResultsEl, sessionTotalEl;
        let stepIndicators = [];
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // è·å–DOMå…ƒç´ 
            colorPicker = document.getElementById('colorPicker');
            gameGrid = document.getElementById('gameGrid');
            touchCountEl = document.getElementById('touchCount');
            reserveGemsEl = document.getElementById('reserveGems');
            roundCountEl = document.getElementById('roundCount');
            gameLog = document.getElementById('gameLog');
            gameStatus = document.getElementById('gameStatus');
            sessionResultsEl = document.getElementById('sessionResults');
            sessionTotalEl = document.getElementById('sessionTotal');
            
            // è·å–æ­¥éª¤æŒ‡ç¤ºå™¨
            for (let i = 1; i <= 5; i++) {
                stepIndicators.push(document.getElementById(`step${i}`));
            }
            
            // åˆ›å»ºé¢œè‰²é€‰æ‹©å™¨
            createColorPicker();
            
            // åˆ›å»ºå®çŸ³ä¹å®«æ ¼
            createGameGrid();
            
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            resetGame();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('playOnceBtn').addEventListener('click', () => playGame(1));
            document.getElementById('playTenBtn').addEventListener('click', () => playGame(10));
            document.getElementById('resetBtn').addEventListener('click', resetGame);
            
            // åˆå§‹æ—¥å¿—
            addLog("æ¸¸æˆå·²åˆå§‹åŒ–ï¼Œè¯·é€‰æ‹©å¹¸è¿è‰²å¼€å§‹æ¸¸æˆ", "normal");
        }
        
        // åˆ›å»ºé¢œè‰²é€‰æ‹©å™¨
        function createColorPicker() {
            colorPicker.innerHTML = '';
            
            COLORS.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color.value;
                colorOption.dataset.colorIndex = index;
                colorOption.innerHTML = `<span style="font-size: 2.2rem;">${color.emoji}</span>`;
                
                colorOption.addEventListener('click', () => {
                    if (gameState.gameActive) return;
                    
                    // ç§»é™¤å…¶ä»–é€‰æ‹©
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // é€‰æ‹©å½“å‰é¢œè‰²
                    colorOption.classList.add('selected');
                    gameState.luckyColor = index;
                    
                    addLog(`å¹¸è¿è‰²å·²é€‰æ‹©ï¼š${color.name}è‰²å®çŸ³`, "normal");
                    updateStatus(`å¹¸è¿è‰²ï¼š${color.name}è‰²å®çŸ³ï¼Œç‚¹å‡»"ç¢°1æ¬¡"æˆ–"ç¢°10æ¬¡"å¼€å§‹æ¸¸æˆ`);
                    
                    // æ’­æ”¾é€‰æ‹©åŠ¨ç”»
                    playSelectionAnimation(colorOption);
                });
                
                colorPicker.appendChild(colorOption);
            });
        }
        
        // æ’­æ”¾é€‰æ‹©åŠ¨ç”»
        function playSelectionAnimation(element) {
            // åˆ›å»ºç²’å­æ•ˆæœ
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createSparkle(element);
                }, i * 50);
            }
        }
        
        // åˆ›å»ºå®çŸ³ä¹å®«æ ¼
        function createGameGrid() {
            gameGrid.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const gemCell = document.createElement('div');
                gemCell.className = 'gem';
                gemCell.dataset.index = i;
                gemCell.innerHTML = 'â“';
                gameGrid.appendChild(gemCell);
            }
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState = {
                luckyColor: null,
                gems: [],
                touchCount: 0,
                reserveGems: 0,
                roundCount: 0,
                gameActive: false,
                currentStep: 0,
                luckyChecked: []
            };
            
            // é‡ç½®é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // é‡ç½®å®çŸ³æ ¼å­
            document.querySelectorAll('.gem').forEach(gem => {
                gem.innerHTML = 'â“';
                gem.style.backgroundColor = '#1a1a2e';
                gem.classList.remove('matched', 'lucky', 'removing', 'appearing');
            });
            
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            stepIndicators.forEach(step => {
                step.classList.remove('active');
            });
            
            // é‡ç½®æ˜¾ç¤º
            touchCountEl.textContent = '0';
            reserveGemsEl.textContent = '0';
            roundCountEl.textContent = '0';
            
            // æ¸…ç©ºæ—¥å¿—
            gameLog.innerHTML = '';
            addLog("æ¸¸æˆå·²é‡ç½®ï¼Œè¯·é€‰æ‹©å¹¸è¿è‰²å¼€å§‹æ¸¸æˆ", "normal");
            
            updateStatus("æ¸¸æˆå‡†å¤‡ä¸­...è¯·é€‰æ‹©å¹¸è¿è‰²");
            
            // é‡ç½®ä¼šè¯ç»Ÿè®¡
            gameSessions = {
                results: [],
                totalTouches: 0,
                currentSession: 0
            };
            updateSessionDisplay();
        }
        
        // ç©æ¸¸æˆï¼ˆå•æ¬¡æˆ–å¤šæ¬¡ï¼‰
        async function playGame(times) {
            if (gameState.luckyColor === null) {
                addLog("è¯·å…ˆé€‰æ‹©å¹¸è¿è‰²ï¼", "normal");
                return;
            }
            
            if (gameState.gameActive) {
                addLog("æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...", "normal");
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é¿å…é‡å¤ç‚¹å‡»
            setButtonsDisabled(true);
            
            if (times === 1) {
                // å•æ¬¡æ¸¸æˆ
                gameSessions.currentSession++;
                addLog(`=== å¼€å§‹ç¬¬ ${gameSessions.currentSession} æ¬¡æ¸¸æˆ ===`, "normal");
                
                // åˆå§‹åŒ–å•æ¬¡æ¸¸æˆ
                initSingleGame();
                
                // æ‰§è¡Œæ¸¸æˆç›´åˆ°ç»“æŸ
                await runGameUntilEnd();
                
                // è®°å½•ç»“æœ
                recordGameResult(gameState.touchCount);
                
                addLog(`ç¬¬ ${gameSessions.currentSession} æ¬¡æ¸¸æˆç»“æŸï¼Œç¢°æ•°ï¼š${gameState.touchCount}`, "final");
            } else {
                // å¤šæ¬¡æ¸¸æˆ
                addLog(`=== å¼€å§‹è¿ç»­ ${times} æ¬¡æ¸¸æˆ ===`, "normal");
                
                for (let i = 1; i <= times; i++) {
                    gameSessions.currentSession++;
                    addLog(`å¼€å§‹ç¬¬ ${gameSessions.currentSession} æ¬¡æ¸¸æˆ`, "normal");
                    
                    // åˆå§‹åŒ–å•æ¬¡æ¸¸æˆ
                    initSingleGame();
                    
                    // æ‰§è¡Œæ¸¸æˆç›´åˆ°ç»“æŸï¼ˆå¿«é€Ÿæ¨¡å¼ï¼Œæ— åŠ¨ç”»å»¶è¿Ÿï¼‰
                    await runGameUntilEnd(true);
                    
                    // è®°å½•ç»“æœ
                    recordGameResult(gameState.touchCount);
                    
                    addLog(`ç¬¬ ${gameSessions.currentSession} æ¬¡æ¸¸æˆç»“æŸï¼Œç¢°æ•°ï¼š${gameState.touchCount}`, "final");
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡ï¼Œç¨ä½œå»¶è¿Ÿ
                    if (i < times) {
                        await sleep(300);
                    }
                }
                
                addLog(`è¿ç»­ ${times} æ¬¡æ¸¸æˆå®Œæˆï¼Œæ€»ç¢°æ•°ï¼š${gameSessions.totalTouches}ï¼Œå¹³å‡ç¢°æ•°ï¼š${(gameSessions.totalTouches / times).toFixed(1)}`, "final");
            }
            
            // å¯ç”¨æŒ‰é’®
            setButtonsDisabled(false);
        }
        
        // åˆå§‹åŒ–å•æ¬¡æ¸¸æˆ
        function initSingleGame() {
            gameState.gems = [];
            gameState.touchCount = 0;
            gameState.reserveGems = 0;
            gameState.roundCount = 0;
            gameState.luckyChecked = [];
            gameState.gameActive = true;
            gameState.currentStep = 0;
            
            // ç”Ÿæˆåˆå§‹å®çŸ³
            generateGems();
            
            // æ›´æ–°æ˜¾ç¤º
            updateGridDisplay();
            touchCountEl.textContent = gameState.touchCount;
            reserveGemsEl.textContent = gameState.reserveGems;
            roundCountEl.textContent = gameState.roundCount;
        }
        
        // æ‰§è¡Œæ¸¸æˆç›´åˆ°ç»“æŸ
        async function runGameUntilEnd(fastMode = false) {
            while (gameState.gameActive && gameState.reserveGems >= 0) {
                await playRound(fastMode);
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (gameState.reserveGems === 0) {
                    gameState.gameActive = false;
                    break;
                }
            }
        }
        
        // è®¾ç½®æŒ‰é’®ç¦ç”¨çŠ¶æ€
        function setButtonsDisabled(disabled) {
            document.getElementById('playOnceBtn').disabled = disabled;
            document.getElementById('playTenBtn').disabled = disabled;
            document.getElementById('resetBtn').disabled = disabled;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (disabled) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        // è®°å½•æ¸¸æˆç»“æœ
        function recordGameResult(touchCount) {
            gameSessions.results.push({
                session: gameSessions.currentSession,
                touches: touchCount
            });
            
            gameSessions.totalTouches += touchCount;
            
            // æ›´æ–°ä¼šè¯æ˜¾ç¤º
            updateSessionDisplay();
        }
        
        // æ›´æ–°ä¼šè¯æ˜¾ç¤º
        function updateSessionDisplay() {
            if (gameSessions.results.length === 0) {
                sessionResultsEl.innerHTML = '<div class="session-result">æš‚æ— æ¸¸æˆè®°å½•</div>';
                sessionTotalEl.textContent = '';
                return;
            }
            
            // æ˜¾ç¤ºæœ€è¿‘10æ¬¡ç»“æœ
            const recentResults = gameSessions.results.slice(-10);
            sessionResultsEl.innerHTML = '';
            
            recentResults.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'session-result';
                if (result.session === gameSessions.currentSession) {
                    resultEl.classList.add('highlight');
                }
                resultEl.textContent = `æ¸¸æˆ${result.session}: ${result.touches}ç¢°`;
                sessionResultsEl.appendChild(resultEl);
            });
            
            // æ›´æ–°æ€»ç¢°æ•°
            sessionTotalEl.textContent = `æ€»ç¢°æ•°: ${gameSessions.totalTouches} | å¹³å‡: ${(gameSessions.totalTouches / gameSessions.results.length).toFixed(1)} | æœ€é«˜: ${Math.max(...gameSessions.results.map(r => r.touches))}`;
        }
        
        // ç¡çœ å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // ç”Ÿæˆéšæœºå®çŸ³
        function generateGems() {
            gameState.gems = [];
            for (let i = 0; i < 9; i++) {
                gameState.gems.push(Math.floor(Math.random() * COLORS.length));
            }
            updateGridDisplay();
        }
        
        // æ›´æ–°ä¹å®«æ ¼æ˜¾ç¤º
        function updateGridDisplay() {
            document.querySelectorAll('.gem').forEach((gem, index) => {
                const colorIndex = gameState.gems[index];
                
                if (colorIndex === undefined || colorIndex === null) {
                    gem.innerHTML = 'â“';
                    gem.style.backgroundColor = '#1a1a2e';
                    gem.classList.remove('matched', 'lucky', 'removing', 'appearing');
                    return;
                }
                
                const color = COLORS[colorIndex];
                gem.innerHTML = color.emoji;
                gem.style.backgroundColor = color.value;
                
                // å¦‚æœå®çŸ³æ˜¯å¹¸è¿è‰²ä¸”æœªè¢«æ£€æŸ¥è¿‡ï¼Œæ·»åŠ é—ªçƒæ•ˆæœ
                if (colorIndex === gameState.luckyColor && !gameState.luckyChecked.includes(index)) {
                    gem.classList.add('lucky');
                } else {
                    gem.classList.remove('lucky');
                }
                
                // ç¡®ä¿ç§»é™¤åŠ¨ç”»ç±»
                gem.classList.remove('removing', 'appearing');
            });
        }
        
        // æ‰§è¡Œä¸€è½®æ¸¸æˆ
        async function playRound(fastMode = false) {
            if (!gameState.gameActive || gameState.reserveGems < 0) return;
            
            gameState.roundCount++;
            roundCountEl.textContent = gameState.roundCount;
            
            if (!fastMode) {
                addLog(`--- ç¬¬ ${gameState.roundCount} è½®æ¼”ç®—å¼€å§‹ ---`, "normal");
            }
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(0);
            
            // ç¬¬1æ­¥ï¼šåˆ¤æ–­å¹¸è¿è‰²
            await checkLuckyColor(fastMode);
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(1);
            
            // ç¬¬2æ­¥ï¼šåˆ¤æ–­å…¨å®¶ç¦
            await checkFullHouse(fastMode);
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(2);
            
            // ç¬¬3æ­¥ï¼šåˆ¤æ–­ä¸‰è¿
            await checkThreeInARow(fastMode);
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(3);
            
            // ç¬¬4æ­¥ï¼šåˆ¤æ–­å¯¹å­ï¼ˆæ”¹è¿›ç‰ˆï¼šä¸ç›¸é‚»çš„å¯¹å­ä¹Ÿèƒ½æ¶ˆé™¤ï¼‰
            await checkPairsImproved(fastMode);
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(4);
            
            // ç¬¬5æ­¥ï¼šè¡¥å……å®çŸ³
            await refillGems(fastMode);
            
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            if (!fastMode) updateStepIndicator(0);
            
            // æ›´æ–°æ˜¾ç¤º
            updateGridDisplay();
            touchCountEl.textContent = gameState.touchCount;
            reserveGemsEl.textContent = gameState.reserveGems;
            
            if (!fastMode) {
                updateStatus(`ç¬¬${gameState.roundCount}è½®æ¼”ç®—å®Œæˆï¼Œå¤‡ç”¨å®çŸ³ï¼š${gameState.reserveGems}`);
            }
        }
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator(step) {
            stepIndicators.forEach((indicator, index) => {
                if (index === step) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
            gameState.currentStep = step;
        }
        
        // ç¬¬1æ­¥ï¼šåˆ¤æ–­å¹¸è¿è‰²
        async function checkLuckyColor(fastMode = false) {
            let luckyCount = 0;
            const luckyMatches = [];
            
            for (let i = 0; i < 9; i++) {
                if (gameState.gems[i] === gameState.luckyColor && 
                    !gameState.luckyChecked.includes(i)) {
                    luckyCount++;
                    gameState.luckyChecked.push(i);
                    luckyMatches.push(i);
                }
            }
            
            if (luckyCount > 0) {
                // æ›´æ–°åˆ†æ•°
                gameState.touchCount += luckyCount;
                gameState.reserveGems += luckyCount;
                
                if (!fastMode) {
                    addLog(`å¹¸è¿è‰²åŒ¹é…ï¼š${luckyCount}ä¸ªå®çŸ³ï¼Œç¢°æ•°+${luckyCount}ï¼Œå¤‡ç”¨å®çŸ³+${luckyCount}`, "match");
                    
                    // æ˜¾ç¤ºåé¦ˆæ–‡æœ¬
                    for (const index of luckyMatches) {
                        showFeedback(index, `å¹¸è¿+1`, 'feedback-lucky');
                        await sleep(300);
                    }
                    
                    // æ·»åŠ åŒ¹é…åŠ¨ç”»
                    for (const index of luckyMatches) {
                        const gem = document.querySelector(`.gem[data-index="${index}"]`);
                        gem.classList.add('matched');
                        await sleep(200);
                    }
                    
                    // ç­‰å¾…åŠ¨ç”»å®Œæˆ
                    await sleep(500);
                }
            }
            
            return luckyCount > 0;
        }
        
        // ç¬¬2æ­¥ï¼šåˆ¤æ–­å…¨å®¶ç¦
        async function checkFullHouse(fastMode = false) {
            // æ£€æŸ¥æ˜¯å¦æœ‰9ä¸ªä¸åŒçš„é¢œè‰²
            const colorSet = new Set();
            let valid = true;
            
            for (let i = 0; i < 9; i++) {
                if (gameState.gems[i] === undefined || gameState.gems[i] === null) {
                    valid = false;
                    break;
                }
                colorSet.add(gameState.gems[i]);
            }
            
            if (valid && colorSet.size === 9) {
                // å…¨å®¶ç¦ï¼
                gameState.touchCount += 10;
                gameState.reserveGems += 10;
                
                if (!fastMode) {
                    // æ˜¾ç¤ºåé¦ˆæ–‡æœ¬
                    showFeedback(4, `å…¨å®¶ç¦+10`, 'feedback-fullhouse');
                    
                    addLog("å…¨å®¶ç¦ï¼9ç§é¢œè‰²å„ä¸åŒï¼Œç¢°æ•°+10ï¼Œå¤‡ç”¨å®çŸ³+10", "bonus");
                    
                    // æ’­æ”¾å…¨å®¶ç¦åŠ¨ç”»
                    await playFullHouseAnimation();
                }
                
                // ç§»é™¤å®çŸ³
                for (let i = 0; i < 9; i++) {
                    gameState.gems[i] = null;
                }
                
                return true;
            }
            
            return false;
        }
        
        // æ’­æ”¾å…¨å®¶ç¦åŠ¨ç”»
        async function playFullHouseAnimation() {
            // æ‰€æœ‰å®çŸ³é—ªçƒ
            for (let i = 0; i < 9; i++) {
                const gem = document.querySelector(`.gem[data-index="${i}"]`);
                gem.classList.add('matched');
            }
            
            await sleep(300);
            
            // åˆ›å»ºå‘å¤–æ‰©æ•£çš„åŠ¨ç”»
            for (let i = 0; i < 9; i++) {
                const gem = document.querySelector(`.gem[data-index="${i}"]`);
                gem.classList.add('removing');
            }
            
            await sleep(800);
        }
        
        // ç¬¬3æ­¥ï¼šåˆ¤æ–­ä¸‰è¿
        async function checkThreeInARow(fastMode = false) {
            const lines = [
                // æ¨ªçº¿
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                // ç«–çº¿
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                // å¯¹è§’çº¿
                [0, 4, 8], [2, 4, 6]
            ];
            
            let threeMatches = 0;
            const matchedIndices = [];
            
            // æ£€æŸ¥æ‰€æœ‰è¿çº¿
            for (const line of lines) {
                const [a, b, c] = line;
                
                // ç¡®ä¿ä¸‰ä¸ªä½ç½®éƒ½æœ‰å®çŸ³ä¸”é¢œè‰²ç›¸åŒ
                if (gameState.gems[a] !== undefined && gameState.gems[a] !== null &&
                    gameState.gems[a] === gameState.gems[b] &&
                    gameState.gems[a] === gameState.gems[c]) {
                    
                    threeMatches++;
                    
                    // è®°å½•åŒ¹é…çš„ä½ç½®
                    matchedIndices.push(a, b, c);
                    
                    if (!fastMode) {
                        // æ˜¾ç¤ºåé¦ˆæ–‡æœ¬
                        showFeedback(line[1], `ä¸‰è¿+5`, 'feedback-bonus');
                    }
                }
            }
            
            // ç§»é™¤é‡å¤çš„ä½ç½®
            const uniqueMatchedIndices = [...new Set(matchedIndices)];
            
            if (threeMatches > 0) {
                const bonus = threeMatches * 5;
                gameState.touchCount += bonus;
                gameState.reserveGems += bonus;
                
                if (!fastMode) {
                    addLog(`ä¸‰è¿åŒ¹é…ï¼š${threeMatches}ç»„ï¼Œç¢°æ•°+${bonus}ï¼Œå¤‡ç”¨å®çŸ³+${bonus}`, "match");
                    
                    // æ’­æ”¾æ¶ˆé™¤åŠ¨ç”»
                    for (const index of uniqueMatchedIndices) {
                        const gem = document.querySelector(`.gem[data-index="${index}"]`);
                        gem.classList.add('removing');
                        await sleep(200);
                    }
                    
                    await sleep(500);
                }
                
                // ç§»é™¤åŒ¹é…çš„å®çŸ³
                uniqueMatchedIndices.forEach(index => {
                    gameState.gems[index] = null;
                });
                
                return true;
            }
            
            return false;
        }
        
        // ç¬¬4æ­¥ï¼šåˆ¤æ–­å¯¹å­ï¼ˆæ”¹è¿›ç‰ˆï¼šä¸ç›¸é‚»çš„å¯¹å­ä¹Ÿèƒ½æ¶ˆé™¤ï¼‰
        async function checkPairsImproved(fastMode = false) {
            // ç»Ÿè®¡æ¯ç§é¢œè‰²çš„å®çŸ³ä½ç½®
            const colorMap = {};
            
            for (let i = 0; i < 9; i++) {
                if (gameState.gems[i] !== undefined && gameState.gems[i] !== null) {
                    if (!colorMap[gameState.gems[i]]) {
                        colorMap[gameState.gems[i]] = [];
                    }
                    colorMap[gameState.gems[i]].push(i);
                }
            }
            
            let pairCount = 0;
            const matchedIndices = [];
            
            // å¯»æ‰¾å¯¹å­ï¼ˆæ”¹è¿›ç‰ˆï¼šä¸ç›¸é‚»çš„ä¹Ÿèƒ½æ¶ˆé™¤ï¼‰
            for (const color in colorMap) {
                const positions = colorMap[color];
                const pairs = Math.floor(positions.length / 2);
                
                if (pairs > 0) {
                    pairCount += pairs;
                    
                    // è®°å½•å‰2*pairsä¸ªä½ç½®ä½œä¸ºå¯¹å­
                    for (let i = 0; i < pairs * 2; i += 2) {
                        matchedIndices.push(positions[i], positions[i+1]);
                        
                        if (!fastMode) {
                            // æ˜¾ç¤ºåé¦ˆæ–‡æœ¬
                            showFeedback(positions[i], `å¯¹å­+1`, 'feedback-pair');
                        }
                    }
                }
            }
            
            if (pairCount > 0) {
                gameState.touchCount += pairCount;
                gameState.reserveGems += pairCount;
                
                if (!fastMode) {
                    addLog(`å¯¹å­åŒ¹é…ï¼š${pairCount}å¯¹ï¼Œç¢°æ•°+${pairCount}ï¼Œå¤‡ç”¨å®çŸ³+${pairCount}`, "match");
                    
                    // æ’­æ”¾æ¶ˆé™¤åŠ¨ç”»
                    for (const index of matchedIndices) {
                        const gem = document.querySelector(`.gem[data-index="${index}"]`);
                        gem.classList.add('removing');
                        await sleep(150);
                    }
                    
                    await sleep(500);
                }
                
                // ç§»é™¤åŒ¹é…çš„å®çŸ³
                matchedIndices.forEach(index => {
                    gameState.gems[index] = null;
                });
                
                return true;
            }
            
            return false;
        }
        
        // ç¬¬5æ­¥ï¼šè¡¥å……å®çŸ³
        async function refillGems(fastMode = false) {
            let refilled = 0;
            const refillIndices = [];
            
            // ä»å·¦è‡³å³ã€ä»ä¸Šè‡³ä¸‹çš„é¡ºåºè¡¥å……
            for (let i = 0; i < 9; i++) {
                if (gameState.gems[i] === null && gameState.reserveGems > 0) {
                    gameState.gems[i] = Math.floor(Math.random() * COLORS.length);
                    gameState.reserveGems--;
                    refilled++;
                    refillIndices.push(i);
                }
            }
            
            if (refilled > 0) {
                if (!fastMode) {
                    addLog(`è¡¥å……å®çŸ³ï¼š${refilled}ä¸ªï¼Œæ¶ˆè€—${refilled}ä¸ªå¤‡ç”¨å®çŸ³`, "normal");
                    
                    // æ’­æ”¾è¡¥å……åŠ¨ç”»
                    for (const index of refillIndices) {
                        const gem = document.querySelector(`.gem[data-index="${index}"]`);
                        gem.classList.add('appearing');
                        await sleep(150);
                    }
                    
                    await sleep(500);
                }
            }
        }
        
        // æ˜¾ç¤ºåé¦ˆæ–‡æœ¬
        function showFeedback(index, text, className) {
            const gem = document.querySelector(`.gem[data-index="${index}"]`);
            const rect = gem.getBoundingClientRect();
            const gridRect = gameGrid.getBoundingClientRect();
            
            const feedback = document.createElement('div');
            feedback.className = `feedback-text ${className}`;
            feedback.textContent = text;
            feedback.style.left = `${rect.left - gridRect.left + rect.width / 2}px`;
            feedback.style.top = `${rect.top - gridRect.top + rect.height / 2}px`;
            
            gameGrid.appendChild(feedback);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                feedback.remove();
            }, 1500);
        }
        
        // åˆ›å»ºé—ªå…‰ç²’å­
        function createSparkle(element) {
            const rect = element.getBoundingClientRect();
            const sparkle = document.createElement('div');
            sparkle.className = 'animated-gem';
            sparkle.innerHTML = element.innerHTML;
            sparkle.style.left = `${rect.left + rect.width / 2}px`;
            sparkle.style.top = `${rect.top + rect.height / 2}px`;
            
            // éšæœºæ–¹å‘
            const angle = Math.random() * Math.PI * 2;
            const distance = 50 + Math.random() * 100;
            const targetX = Math.cos(angle) * distance;
            const targetY = Math.sin(angle) * distance;
            
            sparkle.style.setProperty('--target-pos', `translate(${targetX}px, ${targetY}px)`);
            
            document.body.appendChild(sparkle);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                sparkle.remove();
            }, 1000);
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = "normal") {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type} new`;
            logEntry.textContent = `[${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}] ${message}`;
            
            gameLog.appendChild(logEntry);
            
            // ç§»é™¤newç±»ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ·»åŠ æ—¶å¯ä»¥å†æ¬¡è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                logEntry.classList.remove('new');
            }, 1000);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            gameStatus.innerHTML = `<p>${message}</p>`;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
